app-id: io.github.sigmasd.pingmonitor

runtime: org.gnome.Platform
runtime-version: "49"
sdk: org.gnome.Sdk

command: run.sh

finish-args:
  - --share=network
  # display
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  # gtk4 wants to access gpu
  - --device=dri

modules:
  - name: iputils
    buildsystem: meson
    config-opts:
      - -DBUILD_PING=true
    sources:
      - type: archive
        url: https://github.com/iputils/iputils/archive/refs/tags/20240117.tar.gz
        sha256: a5d66e2997945b2541b8f780a7f5a5ec895d53a517ae1dc4f3ab762573edea9a

  - name: iproute2
    buildsystem: autotools
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
      - SBINDIR=${FLATPAK_DEST}/bin
      - CONFDIR=${FLATPAK_DEST}/etc/iproute2
    sources:
      - type: archive
        url: https://mirrors.edge.kernel.org/pub/linux/utils/net/iproute2/iproute2-6.2.0.tar.xz
        sha256: 4d72730200ec5b2aabaa1a2f20553c6748292f065d9a154c7d5e22559df9fd62

  - name: pingmonitor
    buildsystem: simple
    build-options:
      env:
        DENO_DIR: deno_dir
        DENORT_BIN: denort
    build-commands:
      - ./deno compile --no-check --cached-only --vendor -o pingmon -A --include src/frontend/ --include src/backend  src/webview/main.ts

      - install -Dm755 pingmon /app/bin/pingmon
      - install -Dm755 run.sh /app/bin/run.sh
      - install -D libwebview.*.so -t /app/bin/

      - install -Dm644 distro/io.github.sigmasd.pingmonitor.desktop -t /app/share/applications/
      - install -Dm644 distro/io.github.sigmasd.pingmonitor.svg -t /app/share/icons/hicolor/scalable/apps/
      - install -Dm644 distro/io.github.sigmasd.pingmonitor.metainfo.xml -t /app/share/metainfo/

    sources:
      # app
      - type: archive
        url: https://github.com/sigmaSd/pingmonitor/archive/refs/tags/0.9.2.tar.gz
        sha256: f863ca0500e8377fda6ad7377d6d610d4369df6e79fe25858933a9c87db425d2

      # deno
      - type: archive
        url: https://github.com/denoland/deno/releases/download/v2.5.6/deno-x86_64-unknown-linux-gnu.zip
        sha256: fd4f6abc1b6a134fa9a4dba56519f1631f44c88e04e4e3e9a8ff5975dfa66e1a
        only-arches:
          - x86_64
      - type: archive
        url: https://github.com/denoland/deno/releases/download/v2.5.6/denort-x86_64-unknown-linux-gnu.zip
        sha256: a82b8690f7c26f6df0805a1145e02108f437a3a1ad6a05a7232bae01dab0ecdb
        only-arches:
          - x86_64
      - type: archive
        url: https://github.com/denoland/deno/releases/download/v2.5.6/deno-aarch64-unknown-linux-gnu.zip
        sha256: f5e60ae3dfceb61e5e5a41f22129e40a8bc17f6393b59e75d7ca19ceef32d824
        only-arches:
          - aarch64
      - type: archive
        url: https://github.com/denoland/deno/releases/download/v2.5.6/denort-aarch64-unknown-linux-gnu.zip
        sha256: ac4e9b29bd88cc0d7c7122f3befad60b9bb65762ef2ee06af437aaad35050f0a
        only-arches:
          - aarch64

      # libwebview ffi library
      - type: file
        url: https://github.com/webview/webview_deno/releases/download/0.9.0/libwebview.x86_64.so
        sha256: 5a66b75e14e9360d5c24ba53574e5ed5b1b476843623721aae8fc47a15a69a42
        only-arches:
          - x86_64
      - type: file
        url: https://github.com/webview/webview_deno/releases/download/0.9.0/libwebview.aarch64.so
        sha256: e9ee12c1fe6f0c587c37cca827586bf5c202fd7e04afcd01b780c993878d132a
        only-arches:
          - aarch64

      # run script
      - type: script
        dest-filename: run.sh
        commands:
          # https://discourse.gnome.org/t/how-to-fix-evolution-not-starting-after-update/25389
          - WEBKIT_DISABLE_SANDBOX_THIS_IS_DANGEROUS=1 PLUGIN_URL=/app/bin exec pingmon "$@"

      - deno-sources.json
